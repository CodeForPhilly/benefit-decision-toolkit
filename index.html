<html>
<head>
  <!--
    required viewer styles
  -->
  <link rel="stylesheet" href="https://unpkg.com/@bpmn-io/form-js@1.9.1/dist/assets/form-js.css">
  <style>
    #form {
      max-width: 800px;
    }
    /* Hide elements whose id contains 'eligibility-result' */
    [id*="eligibility-result"] {
      display: none;
    }
  </style>
</head>

<body>
  <div id="messageBox"></div>
  
  <div id="form"></div>
  
  <!--
    add your form schema to this script tag
    alternatively, load it asynchronously from anywhere
  -->
  <script type="application/form-schema">
    {
      "components": [
      {
        "text": "# Philly Pre K Screener\nAnswer the following questions to see if you are eligible for the [Philly Pre K Program](https://www.phlprek.org/).",
        "label": "Text view",
        "type": "text",
        "layout": {
          "row": "Row_0i87qsb",
          "columns": null
        },
        "id": "Field_0tdr6h8"
      },
      {
        "label": "Are you already enrolled in the Philly Pre K program?",
        "type": "radio",
        "layout": {
          "row": "Row_0nspwgm",
          "columns": null
        },
        "id": "Field_0ybuot5",
        "key": "inputs.notPreK",
        "valuesExpression": "=[\n  {label: \"Yes\", value: false},\n  {label: \"No\", value: true}\n]",
        "readonly": false
      },
      {
        "text": "{{#if form.empty }}\n### _Answer the questions to see if you are likely eligible._\n{{/if}}\n\n{{#if eligibility.result = false}}\n## Hmm, it looks like you are not eligible :(\n{{/if}}\n\n{{#if form.empty = false and form.complete = false and eligibility.result = true }}\n## Keep answering questions; so far so good!\n{{/if}}\n\n{{#if form.complete and eligibility.result = true}}\n## You are likely eligible!\n{{/if}}\n",
        "label": "Text view",
        "type": "text",
        "layout": {
          "row": "Row_0nspwgm",
          "columns": null
        },
        "id": "Field_0kizhm8",
        "properties": {}
      },
      {
        "label": "Do you live in Philadelphia?",
        "type": "radio",
        "layout": {
          "row": "Row_16dbot0",
          "columns": null
        },
        "id": "Field_1alvx1l",
        "key": "inputs.livesInPhiladelphiaPa",
        "valuesExpression": "=[\n  {label: \"Yes\", value: true},\n  {label: \"No\", value: false}\n]",
        "readonly": false
      },
      {
        "label": "Do you have a child who will be age 3 or 4 on September 1st?",
        "type": "radio",
        "layout": {
          "row": "Row_0bo7hed",
          "columns": null
        },
        "id": "Field_0cvm67o",
        "key": "inputs.childAgeThreeOrFourSeptFirst",
        "valuesExpression": "=[\n  {label: \"Yes\", value: true},\n  {label: \"No\", value: false}\n]",
        "readonly": false
      },
      {
        "label": "Separator",
        "type": "separator",
        "layout": {
          "row": "Row_16d1vwd",
          "columns": null
        },
        "id": "Field_0qhrltc"
      },
      {
        "action": "submit",
        "label": "Check Eligibility",
        "type": "button",
        "layout": {
          "row": "Row_08zpf73",
          "columns": null
        },
        "id": "Field_1l769kh"
      },
      {
        "action": "reset",
        "label": "Reset",
        "type": "button",
        "layout": {
          "row": "Row_08zpf73",
          "columns": null
        },
        "id": "Field_0ogtl4j"
      },
      {
        "label": "",
        "type": "checkbox",
        "layout": {
          "row": "Row_1qs39ef",
          "columns": null
        },
        "id": "eligibility-result",
        "key": "eligibility.result",
        "defaultValue": null,
        "readonly": true
      },
      {
        "computeOn": "change",
        "label": "Expression",
        "type": "expression",
        "layout": {
          "row": "Row_15ktg13",
          "columns": null
        },
        "id": "Field_1sgvb8c",
        "key": "form.complete",
        "expression": "=every entry in (get entries(inputs)) satisfies entry.value != null"
      },
      {
        "computeOn": "change",
        "label": "Expression",
        "type": "expression",
        "layout": {
          "row": "Row_1xf6fss",
          "columns": null
        },
        "id": "Field_0katvag",
        "key": "form.empty",
        "expression": "=every entry in (get entries(inputs)) satisfies (entry.value = null)"
      }
      ],
      "type": "default",
      "id": "Form_0h2rlra",
      "executionPlatform": "Camunda Cloud",
      "executionPlatformVersion": "8.5.0",
      "exporter": {
        "name": "Camunda Modeler",
        "version": "5.27.0"
      },
      "schemaVersion": 16
    }
  </script>
  
  <!--
    required viewer script
  -->
  <script src="https://unpkg.com/@bpmn-io/form-js@1.9.1/dist/form-viewer.umd.js"></script>
  <script src="https://unpkg.com/@bpmn-io/form-js@1.9.1/dist/form-editor.umd.js"></script>
  
  <script>
    let isUpdating = null;
    
    const schema = JSON.parse(
    document.querySelector('[type="application/form-schema"]').textContent
    );
    
    const container = document.querySelector('#form');
    
    const promise = FormViewer.createForm({
      container,
      schema
    });
    
    promise
    .then(form => {
      form.on('submit', (event) => {
        // will we even need/want the submit event?
        console.log(event.data, event.errors);
      });
      
      // Runs whenever the form is changed
      // 500 is the priority of this listener... not sure how this works
      form.on('changed', 500, (event) => {
        if (isUpdating) {
          console.log('Already updating...', event.data);
          return;
        }
        console.log('Form <changed>', event);
          
          isUpdating = true;
          
          // the URL to POST to.
          // If using Project IDX, this will be generated for you when
          // you start the quarkus dev server.
          const url = 'https://8080-idx-githubcom-1724949033951.cluster-2xid2zxbenc4ixa74rpk7q7fyk.cloudworkstations.dev/benefits/phlPreK';
          // const url = 'http://localhost:8080/benefits/phlPreK';
          
          // Get the auth token from IDX editor's "Generate Access Token" command
          // and paste it here. (Only lasts for an hour).
          const token = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL2Nsb3VkLmdvb2dsZS5jb20vd29ya3N0YXRpb25zIiwiYXVkIjoiaWR4LWdpdGh1YmNvbS0xNzI0OTQ5MDMzOTUxLmNsdXN0ZXItMnhpZDJ6eGJlbmM0aXhhNzRycGs3cTdmeWsuY2xvdWR3b3Jrc3RhdGlvbnMuZGV2IiwiaWF0IjoxNzI4MzI3MTI2LCJleHAiOjE3MjgzMzA3MjZ9.AvvLT5v5lpNXV4t4z9oiad2SWfa6IhXZmFy7sgUoNg-6Ee_03z9cq46PqP2wwHYOCcsN89dmDGcjSc7k1peXsRyoo6znpYgtiTbFr7_JpUyarIr_2tDP-t9wOsJ0-aBbk2f5A-fsqsMmMHw-F74kHRzLrAe80xfbFvCHeWEGKFB7nadUktEGf9MzObUG0QmubC21s4Ld1Y-xOdleht-_lp1IJKKf7ixPYDEvApjlYUI7zFmr7rV8LHIuxvMEfjUHmkR0Ww2hDSfA0ID8bqcZIj2E73ZL5HsD67W8ByhTWcFsQh-q1XvH5T1cN9l4IfNXSI3bqAX_nEInYq6iapVokA'
          
          // Send the output data of the form which is on the event
          const data = event.data;
          
          // Post the JSON data to the URL and log the response
          fetch(url, {
            method: 'POST', // Specify the HTTP method
            headers: {
              'Content-Type': 'application/json', // Ensure the content type is JSON
              'Authorization': `Bearer ${token}`},
              body: JSON.stringify(data) // Convert the data to JSON
            })
            .then(response => response.json()) // Parse the JSON response
            .then(responseData => {
              console.log('Response:', responseData);
              form.setProperty("responseData", responseData);
              
              // document.getElementById('messageBox').innerText = responseData.eligibility.result;
              
              console.log("Got to the update step");
              const field = form
              .get('formFieldRegistry')
              .getAll()
              .find((formField) => formField.key === 'eligibility.result');
              
              console.log("All fields: ", form.get('formFieldRegistry').getAll());
              console.log("Field to update: ", field);
              
              form._update({
                fieldInstance: { id: field.id, valuePath: ['eligibility', 'result'] },
                value: responseData.eligibility.result,
              });
              
              setTimeout(() => {
                isUpdating = false; 
              }, 0.1);
              console.log('Form after updating responseData property:', form);
              const updatedState = responseData;
              return updatedState;
            })
            .then(result => {
              console.log('Success:', result); // Log the result if successful
            })
            .catch(error => {
              console.error('Error:', error); // Log any errors if the request fails
              setTimeout(() => {
                isUpdating = false; 
              }, 0.1);
            });
          });
        });
      </script>
    </body>
    </html>
    